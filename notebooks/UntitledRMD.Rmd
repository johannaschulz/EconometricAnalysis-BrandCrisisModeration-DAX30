# Master Thesis Johanna Schulz

This .Rmd file includes the code for the econometric analysis for the master thesis of Johanna Schulz.
Specifically, this file include the analysis for the main analysis.

## Load libraries
```{r}
install.packages(readxl)
library(readxl)

install.packages(ggplot2)
library(ggplot2)

install.packages(ggcorrplot)
library(ggcorrplot)

install.packages(dplyr)
library(dplyr)

install.packages(lmtest)
library(lmtest)

install.packages(tidyverse)
library(tidyverse)

install.packages(tseries)
library(tseries)

install.packages(car)
library(car)

install.packages("plm")
library(plm)

install.packages("ggtext")
library(ggtext)
```


## Import and view the data set
```{r}
file_path <- "../outputs/monthly_vwap_brand_CPI_data.xlsx"

data <- read_excel(file_path)
```


```{r}
head(data)
str(data) # I inspect the data types of the variables and will make some changes now#
```
The data types of some of the columns is not perfectly assigned for the following analysis in R. Therefore, some are converted:
```{r}
data$Industry <- as.factor(data$Industry) # because it is a categorical variable
data$Sector <- as.factor(data$Sector) # same applies as above
data$StrongBrand <- as.factor(data$StrongBrand) # dummy variable, therefore factor type is better than numerical
data$MultipleStrongBrands <- as.factor(data$MultipleStrongBrands) # same applies as above
data$Crisis <- as.factor(data$Crisis) # same applies as above

```


## Econometric Analysis

```{r}
# Convert data to a pdata.frame, 'CompanyName' and 'MonthYear' are your cross-sectional and time identifiers
pdata <- pdata.frame(data, index = c("CompanyName", "MonthYear"))
```

### Descriptive Analysis

#### Correlation Analysis of the (Continuous) Variables
```{r}
# Correlation between VWAP and other numerical variables
data_corr <- data[, c("VWAP", "BrandRanking", "CPI", "CPI_Change_MoM", "CPI_Change_YoY", "TR", "EBIT", "EBITDA")]

corr_matrix <- cor(data_corr, use = "complete.obs")

corr_matrix
```
#### Scatter Plot VWAP - CPI
```{r}
# Create a scatter plot of VWAP vs CPI
ggplot(data, aes(x = CPI, y = VWAP)) +
  geom_point() +
  labs(title = "Scatter Plot of VWAP vs CPI", x = "CPI", y = "VWAP") +
  theme_minimal()

```
```{r}
# Create a scatter plot of VWAP vs CPI, colored by TickerCode
ggplot(data, aes(x = CPI, y = VWAP, color = TickerCode)) +
  geom_point() +
  labs(title = "Scatter Plot of VWAP vs CPI by Company", x = "CPI", y = "VWAP") +
  theme_minimal() +
  theme(legend.position = "bottom") 

```
```{r}
# Create a time series plot for CPI
ggplot(data, aes(x = MonthYear, y = CPI)) +
  geom_line() +  # Use geom_line for time series
  labs(title = "Time Series of CPI per Month", x = "Month-Year", y = "CPI") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))  # Rotate x-axis labels for clarity

```

#### Grouped Summary Statistics for Dummy Variables
```{r}
# Summary of VWAP by StrongBrand
data %>%
  group_by(StrongBrand) %>%
  summarise(Mean_VWAP = mean(VWAP, na.rm = TRUE),
            Median_VWAP = median(VWAP, na.rm = TRUE),
            SD_VWAP = sd(VWAP, na.rm = TRUE))

```

```{r}
# Summary of VWAP by MutlipleBrands
data %>%
  group_by(MultipleStrongBrands) %>%
  summarise(Mean_VWAP = mean(VWAP, na.rm = TRUE),
            Median_VWAP = median(VWAP, na.rm = TRUE),
            SD_VWAP = sd(VWAP, na.rm = TRUE))

```

```{r}
# Summary of VWAP by Crisis
data %>%
  group_by(Crisis) %>%
  summarise(Mean_VWAP = mean(VWAP, na.rm = TRUE),
            Median_VWAP = median(VWAP, na.rm = TRUE),
            SD_VWAP = sd(VWAP, na.rm = TRUE))
```
```{r}
library(dplyr)

# mean of VWAP for each level of Crisis
mean_vwap_by_crisis <- data %>%
  group_by(Crisis) %>%
  summarise(Mean_VWAP = mean(VWAP, na.rm = TRUE))

print(mean_vwap_by_crisis)
```
```{r}
# mean of VWAP for each combination of Crisis and StrongBrand
mean_vwap_by_crisis_strongbrand <- data %>%
  group_by(Crisis, StrongBrand) %>%
  summarise(Mean_VWAP = mean(VWAP, na.rm = TRUE))

print(mean_vwap_by_crisis_strongbrand)
```
```{r}
library(dplyr)
library(ggplot2)

mean_vwap_data <- data %>%
  group_by(StrongBrand, Crisis) %>%
  summarise(Mean_VWAP = mean(VWAP, na.rm = TRUE)) %>%
  mutate(Category = factor(paste("StrongBrand =", StrongBrand, "- Crisis =", Crisis),
                           levels = c("StrongBrand = 1 - Crisis = 0", 
                                      "StrongBrand = 1 - Crisis = 1",
                                      "StrongBrand = 0 - Crisis = 0",
                                      "StrongBrand = 0 - Crisis = 1")))

library(ggtext)

custom_labels <- c("Crisis = 0<br><span style='margin-top:10px; display:block; text-align:center;'><strong>Strong Brand = 1</strong></span>", 
                   "", 
                   "Crisis = 0<br><span style='margin-top:10px; display:block; text-align:center;'><strong>Strong Brand = 0</strong></span>", 
                   "")

ggplot(mean_vwap_data, aes(x = Category, y = Mean_VWAP, fill = Category)) +
  geom_bar(stat = "identity", position = position_dodge(), width = 0.6) +
  scale_fill_grey(start = 0.8, end = 0.5) +
  geom_text(aes(label = round(Mean_VWAP, 2)), vjust = -0.5, position = position_dodge(width = 0.6)) +
  labs(title = "Mean VWAP Values by StrongBrand and Crisis Status",
       x = "",  
       y = "Mean VWAP") +
  scale_x_discrete(labels = custom_labels) +
  theme_minimal() +
  theme(legend.position = "none",
        axis.text.x = element_markdown()) 
```

### Models

#### Hypotheses H1a-H1b | Model 1.0 (without controls), Model 1.1 (with controls), Model 1.2 - CPI as IV (with controls)

```{r}
# Model 1.0 without controls, Crisis as IV
linreg1_0 <- lm(VWAP ~ Crisis, data = data)
summary(linreg1_0)
```
##### Stepwise Controls Adding
```{r}
# Adding 1 control: Sector Information
linreg1_0A <- lm(VWAP ~ Crisis + Sector, data = data)
summary(linreg1_0A)
```

```{r}
# Adding 2nd control: TR
linreg1_0A <- lm(VWAP ~ Crisis + Sector + TR, data = data)
summary(linreg1_0A)
```

```{r}
# Adding 3rd control: EBIT
linreg1_1 <- lm(VWAP ~ Crisis + Sector + TR + EBIT, data = data)
summary(linreg1_1)
```
```{r}
# Finally: Adding 4th control: lagged VWAP
# Model 1.1 with controls, Crisis as IV
linreg1_1 <- lm(VWAP ~ Crisis + Sector + TR + EBIT + VWAP_lagged, data = data)
summary(linreg1_1)
```

##### OLS Assumptions | Model 1.1 (with controls) "linreg1_1"
Random sample: observations are iid

1. Nonzero expectation: Zero mean for errors
2. Homoscedasticity: Constant variance for errors
3. Pairwise uncorrelated errors
4. Errors distributed multivariate normal
5. Nonstochastic regressors
6. No multicollinearity

--> All tests need to be NOT significant to meet assumptions

```{r}
# 1. Nonzero expectation: Zero mean for errors -> Resest test
resettest(linreg1_1) #significant, assumption violated
```

```{r}
# 2. Homoscedasticity: Constant variance for errors -> Breusch Pagan Test & Goldfeld-Quandt Test
gqtest(linreg1_1) # not significant, assumption holds
```

```{r}
# 3. Pairwise uncorrelated errors -> Plotting residuals against time
plot(residuals(linreg1_1) ~ data$MonthYear) # random, assumption holds
```

```{r}
# 4. Errors distributed multivariate normal -> Jarque and Bera (1980)
jarque.bera.test(residuals(linreg1_1)) #significant -> VIOLATED
```
```{r}
# 5. Nonstochastic regressors, no correlation of predictor and residuals -> results should show no correlation 
residuals <- residuals(linreg1_1)

#results should show no correlation --> VIOLATED
cor.test(residuals,data$VWAP) #correlation = 0.99
#cor.test(residuals,data$Crisis) # correlation = 1.803057e-16 
```

```{r}
# 6. No multicollinearity -> VIF values should be smaller than 4
## does not apply because only one predictor yet
```

```{r}
# Finally, adding Heteroskedasticity Robust Standard Errors to the model to account for the violations
library(lmtest)
library(sandwich)
# Robust t test
coeftest_results <- coeftest(linreg1_1, vcov = vcovHC(linreg1_1, type = "HC0"))

print(coeftest_results)
```
#### Model 1.2 | Hypothesis H1b, CPI as predictor
```{r}
# Model 1.2 without controls, CPI as IV
linreg1_2 <- lm(VWAP ~ CPI, data = data)
summary(linreg1_2)
```
```{r}
# stepwise control adding
linreg1_2 <- lm(VWAP ~ CPI + Sector, data = data)
summary(linreg1_2)
```

```{r}
# stepwise control adding
linreg1_2 <- lm(VWAP ~ CPI + Sector + TR, data = data)
summary(linreg1_2)
```
```{r}
# stepwise control adding
linreg1_2 <- lm(VWAP ~ CPI + Sector + TR + EBIT, data = data)
summary(linreg1_2)
```


```{r}
# Model 1.2 with controls, CPI as IV
linreg1_2 <- lm(VWAP ~ CPI + Sector + TR + EBIT + VWAP_lagged, data = data)
summary(linreg1_2)
```
##### OLS Assumptions for Model 1.2 | linreg1_2
```{r}
# 1. Nonzero expectation: Zero mean for errors -> Resest test
resettest(linreg1_2) #significant, assumption violated
```
```{r}
# 2. Homoscedasticity: Constant variance for errors -> Breusch Pagan Test & Goldfeld-Quandt Test
gqtest(linreg1_2) # not significant, assumption holds
```
```{r}
# 3. Pairwise uncorrelated errors -> Plotting residuals against time
plot(residuals(linreg1_2) ~ data$MonthYear) # random, assumption holds
```
```{r}
# 4. Errors distributed multivariate normal -> Jarque and Bera (1980)
jarque.bera.test(residuals(linreg1_2)) #significant -> VIOLATED
```
```{r}
# 5. Nonstochastic regressors, no correlation of predictor and residuals -> results should show no correlation 
residuals <- residuals(linreg1_2)

#results should show no correlation --> VIOLATED
cor.test(residuals,data$VWAP) #correlation = 0.99
#cor.test(residuals,data$Crisis) # correlation = 1.803057e-16 
```
```{r}
# 6. No multicollinearity -> VIF values should be smaller than 4
## does not apply because only one predictor yet
```

```{r}
# Finally, adding Heteroskedasticity Robust Standard Errors to the model to account for the violations

# Robust t test
coeftest_results <- coeftest(linreg1_2, vcov = vcovHC(linreg1_2, type = "HC0"))

print(coeftest_results)
```
#### Hypotheses H2a-H2b | Model 2.0 (with controls) - Crisis and StrongBrand as IV, Model 2.1 (with controls) - CPI and StrongBrand as IV

##### Model 2.0 - Crisis and StrongBrand as IV
```{r}
# without controls
linreg_2_0 <- lm(VWAP ~ Crisis + StrongBrand + (Crisis*StrongBrand), data = data)
summary(linreg_2_0)
```
```{r}
# without controls
linreg_2_0 <- lm(VWAP ~ Crisis + StrongBrand + (Crisis*StrongBrand) + Sector, data = data)
summary(linreg_2_0)
```

```{r}
# without controls
linreg_2_0 <- lm(VWAP ~ Crisis + StrongBrand + (Crisis*StrongBrand) + Sector + TR, data = data)
summary(linreg_2_0)
```

```{r}
# without controls
linreg_2_0 <- lm(VWAP ~ Crisis + StrongBrand + (Crisis*StrongBrand) + Sector + TR + EBIT, data = data)
summary(linreg_2_0)
```


```{r}
# with controls
linreg_2_0 <- lm(VWAP ~ Crisis + StrongBrand + (Crisis*StrongBrand) + Sector + EBIT + TR + VWAP_lagged, data = data)
summary(linreg_2_0)
```

##### OLS Assumptions for Model 2.0 | linreg_2_0
```{r}
# 1. Nonzero expectation: Zero mean for errors -> Resest test
resettest(linreg_2_0) #significant, assumption violated
```
```{r}
# 1. Nonzero expectation: Zero mean for errors -> Resest test
resettest(linreg_2_0) #significant, assumption violated
```

```{r}
# 2. Homoscedasticity: Constant variance for errors -> Breusch Pagan Test & Goldfeld-Quandt Test
gqtest(linreg_2_0) # not significant, assumption holds
```

```{r}
# 3. Pairwise uncorrelated errors -> Plotting residuals against time
plot(residuals(linreg_2_0) ~ data$MonthYear) # random, assumption holds
```

```{r}
# 4. Errors distributed multivariate normal -> Jarque and Bera (1980)
jarque.bera.test(residuals(linreg_2_0)) #significant -> VIOLATED
```

```{r}
# 5. Nonstochastic regressors, no correlation of predictor and residuals -> results should show no correlation 
residuals <- residuals(linreg_2_0)

#results should show no correlation --> VIOLATED
cor.test(residuals,data$VWAP) #correlation = 0.99
#cor.test(residuals,data$Crisis) # correlation = 1.803057e-16 
```

```{r}
# 6. No multicollinearity -> VIF values should be smaller than 4
## does not apply because only one predictor yet
```

```{r}
# Finally, adding Heteroskedasticity Robust Standard Errors to the model to account for the violations

# Robust t test
coeftest_results <- coeftest(linreg_2_0, vcov = vcovHC(linreg_2_0, type = "HC0"))

print(coeftest_results)
```

##### Model 2.1 - CPI and StrongBrand as IV 
```{r}
# without controls (see Table x in Appendix)
linreg_2_1 <- lm(VWAP ~ CPI + StrongBrand + (CPI*StrongBrand), data = data)
summary(linreg_2_1)
```
```{r}
# stepwise control adding 
linreg_2_1 <- lm(VWAP ~ CPI + StrongBrand + (CPI*StrongBrand) + Sector, data = data)
summary(linreg_2_1)
```
```{r}
# stepwise control adding 
linreg_2_1 <- lm(VWAP ~ CPI + StrongBrand + (CPI*StrongBrand) + Sector + TR , data = data)
summary(linreg_2_1)
```
```{r}
# stepwise control adding 
linreg_2_1 <- lm(VWAP ~ CPI + StrongBrand + (CPI*StrongBrand) + Sector + TR + EBIT, data = data)
summary(linreg_2_1)
```

```{r}
# with controls  
linreg_2_1 <- lm(VWAP ~ CPI + StrongBrand + (CPI*StrongBrand) + Sector + TR + EBIT + VWAP_lagged, data = data)
summary(linreg_2_1)
```

```{r}
# 1. Nonzero expectation: Zero mean for errors -> Resest test
resettest(linreg_2_1) #significant, assumption violated
```

```{r}
# 2. Homoscedasticity: Constant variance for errors -> Breusch Pagan Test & Goldfeld-Quandt Test
gqtest(linreg_2_1) # not significant, assumption holds
```

```{r}
# 3. Pairwise uncorrelated errors -> Plotting residuals against time
plot(residuals(linreg_2_1) ~ data$MonthYear) # random, assumption holds
```

```{r}
# 4. Errors distributed multivariate normal -> Jarque and Bera (1980)
jarque.bera.test(residuals(linreg_2_1)) #significant -> VIOLATED
```

```{r}
# 5. Nonstochastic regressors, no correlation of predictor and residuals -> results should show no correlation 
residuals <- residuals(linreg_2_1)

#results should show no correlation --> VIOLATED
cor.test(residuals,data$VWAP) #correlation = 0.99
#cor.test(residuals,data$Crisis) # correlation = 1.803057e-16 
```

```{r}
# 6. No multicollinearity -> VIF values should be smaller than 4
## does not apply because only one predictor yet
```

```{r}
# Finally, adding Heteroskedasticity Robust Standard Errors to the model to account for the violations

# Robust t test
coeftest_results <- coeftest(linreg_2_1, vcov = vcovHC(linreg_2_1, type = "HC0"))

print(coeftest_results)
```
#### Hypotheses H3a-H3b | Model 3.0 (with controls) - Crisis and BrandRanking as IV, Model 3.1 (with controls) - CPI and BrandRanking as IV

```{r}
subset_strongbrand <- subset(data, StrongBrand == 1)

head(subset_strongbrand)
```

#### Model 3.0 - Crisis and BrandRanking as IV
```{r}
# without controls
linreg_3_0 <- lm(VWAP ~ Crisis + BrandRanking + (Crisis*BrandRanking), data = subset_strongbrand)
summary(linreg_3_0)
```
```{r}
# stepwise control adding
linreg_3_0 <- lm(VWAP ~ Crisis + BrandRanking + (Crisis*BrandRanking) + Sector, data = subset_strongbrand)
summary(linreg_3_0)
```

```{r}
# stepwise control adding
linreg_3_0 <- lm(VWAP ~ Crisis + BrandRanking + (Crisis*BrandRanking) + Sector + TR, data = subset_strongbrand)
summary(linreg_3_0)
```
```{r}
# stepwise control adding
linreg_3_0 <- lm(VWAP ~ Crisis + BrandRanking + (Crisis*BrandRanking) + Sector + TR + EBIT, data = subset_strongbrand)
summary(linreg_3_0)
```

```{r}
# with controls
linreg_3_0 <- lm(VWAP ~ Crisis + BrandRanking + (Crisis*BrandRanking) + Sector + TR + EBIT + VWAP_lagged, data = subset_strongbrand)

summary(linreg_3_0)
```

##### OLS Assumptions for Model 3.0
```{r}
# 1. Nonzero expectation: Zero mean for errors -> Resest test
resettest(linreg_3_0) # significant, violated
```

```{r}
# 2. Homoscedasticity: Constant variance for errors -> Breusch Pagan Test & Goldfeld-Quandt Test
gqtest(linreg_3_0) # not significant, assumptions holds
```

```{r}
# 3. Pairwise uncorrelated errors -> Plotting residuals against time
plot(residuals(linreg_3_0) ~ data$MonthYear) # random, assumption holds
```


```{r}
# 4. Errors distributed multivariate normal -> Jarque and Bera (1980)
jarque.bera.test(residuals(linreg_3_0)) # significant -> VIOLATED

# additional test: Shapiro-Wilk 
shapiro.test(residuals(linreg_3_0)) # significant -> VIOLATED
```

```{r}
# 6. No multicollinearity -> VIF values should be smaller than 4
vif(linreg_3_0)

```

```{r}
# Finally, adding Heteroskedasticity Robust Standard Errors to the model to account for the violations

# Robust t test
coeftest_results <- coeftest(linreg_3_0, vcov = vcovHC(linreg_3_0, type = "HC0"))

print(coeftest_results)
```

#### Model 3.1 - CPI and BrandRanking as IV

```{r}
# without controls
linreg_3_1 <- lm(VWAP ~ CPI + BrandRanking + (CPI*BrandRanking), data = subset_strongbrand)
summary(linreg_3_1)
```

```{r}
# stepwise control adding
linreg_3_1 <- lm(VWAP ~ CPI + BrandRanking + (CPI*BrandRanking), data = subset_strongbrand)
summary(linreg_3_1)
```

```{r}
# with controls
linreg_3_1 <- lm(VWAP ~ CPI + BrandRanking + (CPI*BrandRanking) + Sector + TR + EBIT + VWAP_lagged, data = subset_strongbrand)
summary(linreg_3_1)
```
```{r}
# 1. Nonzero expectation: Zero mean for errors -> Resest test
resettest(linreg_3_1) #significant, assumption violated
```

```{r}
# 2. Homoscedasticity: Constant variance for errors -> Breusch Pagan Test & Goldfeld-Quandt Test
gqtest(linreg_3_1) # not significant, assumption holds
```

```{r}
# 3. Pairwise uncorrelated errors -> Plotting residuals against time
plot(residuals(linreg_3_1) ~ data$MonthYear) # random, assumption holds
```

```{r}
# 4. Errors distributed multivariate normal -> Jarque and Bera (1980)
jarque.bera.test(residuals(linreg_3_1)) #significant -> VIOLATED
```

```{r}
# 5. Nonstochastic regressors, no correlation of predictor and residuals -> results should show no correlation 
residuals <- residuals(linreg_3_1)

#results should show no correlation --> VIOLATED
cor.test(residuals,data$VWAP) #correlation = 0.99
#cor.test(residuals,data$Crisis) # correlation = 1.803057e-16 
```

```{r}
# 6. No multicollinearity -> VIF values should be smaller than 4
## does not apply because only one predictor yet
```

```{r}
# Finally, adding Heteroskedasticity Robust Standard Errors to the model to account for the violations

# Robust t test
coeftest_results <- coeftest(linreg_3_1, vcov = vcovHC(linreg_3_1, type = "HC0"))

print(coeftest_results)
```

#### Model 2.2 | Adding Fixed Effects



```{r}
fe_model_2_2 <- plm(VWAP ~ CPI + Crisis + (Crisis*CPI), 
                data = pdata, model = "within")

#summary(fe_model_2_2)
summary(fe_model_2_2, effect = "individual")
```

##### Hausman test
```{r}
# random effects model
re_model_2_2 <- plm(VWAP ~ Crisis + StrongBrand + (Crisis * StrongBrand), 
                    data = pdata, model = "random")

# Perform Hausman test
hausman_test <- phtest(fe_model_2_2, re_model_2_2)
print(hausman_test) # 
```





### Robustness Tests

#### Simple Linear Regression | StrongBrand as Predictor
```{r}
# with all observations
#linreg2 <- lm(VWAP ~ StrongBrand, data = data)
#summary(linreg2)

```

```{r}
# with subset for crisis = 0
data_no_crisis <- subset(data, Crisis == 0)

linreg2_no_crisis <- lm(VWAP ~ StrongBrand, data = data_no_crisis)
summary(linreg2_no_crisis)

```

```{r}
# 1. Nonzero expectation: Zero mean for errors -> Resest test
resettest(linreg_2_0) #significant, assumption violated
```

```{r}
# 2. Homoscedasticity: Constant variance for errors -> Breusch Pagan Test & Goldfeld-Quandt Test
gqtest(linreg_2_0) # not significant, assumption holds
```

```{r}
# 3. Pairwise uncorrelated errors -> Plotting residuals against time
plot(residuals(linreg_2_0) ~ data$MonthYear) # random, assumption holds
```

```{r}
# 4. Errors distributed multivariate normal -> Jarque and Bera (1980)
jarque.bera.test(residuals(linreg_2_0)) #significant -> VIOLATED
```

```{r}
# 5. Nonstochastic regressors, no correlation of predictor and residuals -> results should show no correlation 
residuals <- residuals(linreg_2_0)

#results should show no correlation --> VIOLATED
cor.test(residuals,data$VWAP) #correlation = 0.99
#cor.test(residuals,data$Crisis) # correlation = 1.803057e-16 
```

```{r}
# 6. No multicollinearity -> VIF values should be smaller than 4
## does not apply because only one predictor yet
```

```{r}
# Finally, adding Heteroskedasticity Robust Standard Errors to the model to account for the violations

# Robust t test
coeftest_results <- coeftest(linreg_2_0, vcov = vcovHC(linreg_2_0, type = "HC0"))

print(coeftest_results)
```


